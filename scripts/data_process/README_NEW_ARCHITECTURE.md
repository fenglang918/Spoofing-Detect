# æ–°æ•°æ®å¤„ç†æ¶æ„è¯´æ˜

## ğŸ¯ æ¶æ„æ¦‚è¿°

é‡æ„åçš„æ•°æ®å¤„ç†ç³»ç»Ÿé‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œå°†å¤æ‚çš„ETLæµç¨‹åˆ†è§£ä¸ºå››ä¸ªç‹¬ç«‹çš„é˜¶æ®µï¼Œæ¯ä¸ªé˜¶æ®µä¸“æ³¨äºç‰¹å®šçš„åŠŸèƒ½ï¼Œæé«˜äº†ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚

## ğŸ“ ç›®å½•ç»“æ„

```
scripts/data_process/
â”œâ”€â”€ raw_data/                   # é˜¶æ®µ1: åŸå§‹æ•°æ®å¤„ç†
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ merge_event_stream.py   # åˆå¹¶å§”æ‰˜å’Œæˆäº¤æ•°æ®
â”œâ”€â”€ features/                   # é˜¶æ®µ2: ç‰¹å¾ç”Ÿæˆ
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ feature_generator.py    # ç‰¹å¾è®¡ç®—å’Œç”Ÿæˆ
â”œâ”€â”€ labels/                     # é˜¶æ®µ3: æ ‡ç­¾ç”Ÿæˆ
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ label_generator.py      # æ ‡ç­¾è®¡ç®—å’Œç”Ÿæˆ
â”œâ”€â”€ analysis/                   # é˜¶æ®µ4: æ•°æ®æ•´åˆåˆ†æ
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ data_integration.py     # æ•°æ®æ•´åˆå’Œè´¨é‡åˆ†æ
â”œâ”€â”€ complete_pipeline.py        # å®Œæ•´æµæ°´çº¿
â””â”€â”€ README_NEW_ARCHITECTURE.md  # æœ¬æ–‡æ¡£
```

## ğŸ”„ æ•°æ®å¤„ç†æµç¨‹

### é˜¶æ®µ1: åŸå§‹æ•°æ®å¤„ç† (`raw_data/`)

**åŠŸèƒ½**: å°†åŸå§‹çš„é€ç¬”å§”æ‰˜å’Œé€ç¬”æˆäº¤æ•°æ®åˆå¹¶ä¸ºç»Ÿä¸€çš„å§”æ‰˜äº‹ä»¶æµ

**è¾“å…¥**: 
- `base_data/{YYYYMMDD}/{YYYYMMDD}/{TICKER}/é€ç¬”å§”æ‰˜.csv`
- `base_data/{YYYYMMDD}/{YYYYMMDD}/{TICKER}/é€ç¬”æˆäº¤.csv`
- `base_data/{YYYYMMDD}/{YYYYMMDD}/{TICKER}/è¡Œæƒ….csv`

**è¾“å‡º**: 
- `event_stream/{YYYYMMDD}/å§”æ‰˜äº‹ä»¶æµ.csv`

**ä¸»è¦åŠŸèƒ½**:
- è‡ªåŠ¨ç¼–ç æ£€æµ‹å’ŒCSVè¯»å–
- å§”æ‰˜ä¸æˆäº¤äº‹ä»¶åˆå¹¶
- è¡Œæƒ…æ•°æ®è´´åˆï¼ˆ100msç½‘æ ¼ï¼‰
- åŸºç¡€ç‰¹å¾è®¡ç®—ï¼ˆå­˜æ´»æ—¶é—´ã€ä»·æ ¼åç¦»ç­‰ï¼‰
- æ•°æ®è´¨é‡æ£€æŸ¥å’Œæ¸…æ´—

**ä½¿ç”¨ç¤ºä¾‹**:
```bash
python scripts/data_process/raw_data/merge_event_stream.py \
    --root "/path/to/base_data" \
    --tickers 000001.SZ 000002.SZ \
    --dates 20230301 20230302
```

### é˜¶æ®µ2: ç‰¹å¾ç”Ÿæˆ (`features/`)

**åŠŸèƒ½**: ä»å§”æ‰˜äº‹ä»¶æµè®¡ç®—å„ç±»å®æ—¶å¯è§‚æµ‹ç‰¹å¾

**è¾“å…¥**: 
- `event_stream/{YYYYMMDD}/å§”æ‰˜äº‹ä»¶æµ.csv`

**è¾“å‡º**: 
- `features/X_{YYYYMMDD}.parquet`

**ä¸»è¦åŠŸèƒ½**:
- åŸºç¡€å®æ—¶ç‰¹å¾ï¼ˆç›˜å£å¿«ç…§ã€ä»·æ ¼ç‰¹å¾ã€æ»šåŠ¨çª—å£ï¼‰
- æ‰©å±•å®æ—¶ç‰¹å¾ï¼ˆz_survivalã€ä»·æ ¼åŠ¨é‡ã€è®¢å•å¯†åº¦ï¼‰
- è®¢å•ç°¿å‹åŠ›ç‰¹å¾ï¼ˆbook_imbalanceã€price_aggressivenessï¼‰
- æ”¯æŒPolars/PandasåŒåç«¯
- **ä¿ç•™æ‰€æœ‰è®¡ç®—ç‰¹å¾ï¼Œä¸è¿›è¡Œè¿‡æ»¤**

**ä½¿ç”¨ç¤ºä¾‹**:
```bash
python scripts/data_process/features/feature_generator.py \
    --input_dir "/path/to/event_stream" \
    --output_dir "/path/to/features" \
    --backend polars \
    --extended
```

### é˜¶æ®µ3: æ ‡ç­¾ç”Ÿæˆ (`labels/`)

**åŠŸèƒ½**: ä»å§”æ‰˜äº‹ä»¶æµç”Ÿæˆæ¬ºéª—äº¤æ˜“æ ‡ç­¾

**è¾“å…¥**: 
- `event_stream/{YYYYMMDD}/å§”æ‰˜äº‹ä»¶æµ.csv`

**è¾“å‡º**: 
- `labels/labels_{YYYYMMDD}.parquet`

**ä¸»è¦åŠŸèƒ½**:
- R1è§„åˆ™ï¼ˆå¿«é€Ÿæ’¤å•ï¼‰
- R2è§„åˆ™ï¼ˆä»·æ ¼æ“çºµï¼‰
- æ‰©å±•æ ‡ç­¾è§„åˆ™ï¼ˆå¯é€‰ï¼‰
- æ”¯æŒå‚æ•°è‡ªå®šä¹‰ï¼ˆæ—¶é—´é˜ˆå€¼ã€ä»·å·®å€æ•°ï¼‰
- **åªä¿ç•™ä¸»é”®å’Œæ ‡ç­¾ç›¸å…³åˆ—**

**ä½¿ç”¨ç¤ºä¾‹**:
```bash
python scripts/data_process/labels/label_generator.py \
    --input_dir "/path/to/event_stream" \
    --output_dir "/path/to/labels" \
    --r1_ms 50 --r2_ms 1000 --r2_mult 4.0 \
    --extended
```

### é˜¶æ®µ4: æ•°æ®æ•´åˆåˆ†æ (`analysis/`)

**åŠŸèƒ½**: æ•´åˆç‰¹å¾å’Œæ ‡ç­¾æ•°æ®ï¼Œè¿›è¡Œå…¨å±€è´¨é‡åˆ†æå’Œæ™ºèƒ½è¿‡æ»¤

**è¾“å…¥**: 
- `features/X_*.parquet`
- `labels/labels_*.parquet`

**è¾“å‡º**: 
- `analysis/integrated_data.parquet` (åŸå§‹æ•´åˆæ•°æ®)
- `analysis/filtered_data.parquet` (è¿‡æ»¤åæ•°æ®)
- `analysis/data_analysis.json` (åˆ†ææŠ¥å‘Š)

**ä¸»è¦åŠŸèƒ½**:
- ç‰¹å¾å’Œæ ‡ç­¾æ•°æ®åˆå¹¶
- å…¨å±€æ•°æ®è´¨é‡åˆ†æ
- ä¿¡æ¯æ³„éœ²ç‰¹å¾æ£€æµ‹
- å¸¸æ•°åˆ—ã€ä½æ–¹å·®ã€é‡å¤ç‰¹å¾è¯†åˆ«
- æ™ºèƒ½è¿‡æ»¤å»ºè®®ç”Ÿæˆ
- **åœ¨å…¨é‡æ•°æ®åŸºç¡€ä¸Šç»Ÿä¸€åˆ†æå’Œè¿‡æ»¤**

**ä½¿ç”¨ç¤ºä¾‹**:
```bash
python scripts/data_process/analysis/data_integration.py \
    --features_dir "/path/to/features" \
    --labels_dir "/path/to/labels" \
    --output_dir "/path/to/analysis" \
    --apply_filter
```

## ğŸš€ å®Œæ•´æµæ°´çº¿

### ä¸€é”®è¿è¡Œå®Œæ•´æµç¨‹

```bash
python scripts/data_process/complete_pipeline.py \
    --base_data_dir "/path/to/base_data" \
    --output_root "/path/to/output" \
    --tickers 000001.SZ 000002.SZ \
    --backend polars \
    --extended_features \
    --r1_ms 50 --r2_ms 1000 --r2_mult 4.0
```

### çµæ´»çš„é˜¶æ®µæ§åˆ¶

```bash
# è·³è¿‡æŸäº›é˜¶æ®µï¼ˆæ¯”å¦‚å·²ç»å®Œæˆçš„é˜¶æ®µï¼‰
python scripts/data_process/complete_pipeline.py \
    --base_data_dir "/path/to/base_data" \
    --output_root "/path/to/output" \
    --skip_stages "1,2"  # è·³è¿‡é˜¶æ®µ1å’Œ2
```

## âœ… æ–°æ¶æ„çš„ä¼˜åŠ¿

### 1. **æ¨¡å—åŒ–è®¾è®¡**
- æ¯ä¸ªé˜¶æ®µåŠŸèƒ½å•ä¸€ã€èŒè´£æ˜ç¡®
- ä¾¿äºè°ƒè¯•ã€æµ‹è¯•å’Œç»´æŠ¤
- æ”¯æŒç‹¬ç«‹è¿è¡Œå’Œç»„åˆä½¿ç”¨

### 2. **çµæ´»çš„å¤„ç†ç­–ç•¥**
- é˜¶æ®µ2ã€3ä¿ç•™æ‰€æœ‰è®¡ç®—ç»“æœï¼Œä¸è¿‡æ—©è¿‡æ»¤
- é˜¶æ®µ4åœ¨å…¨é‡æ•°æ®åŸºç¡€ä¸Šç»Ÿä¸€åˆ†æè¿‡æ»¤
- é¿å…äº†ç‰¹å¾ä¸ä¸€è‡´çš„é—®é¢˜

### 3. **æ™ºèƒ½åŒ–è´¨é‡æ§åˆ¶**
- å¤šç»´åº¦æ•°æ®è´¨é‡åˆ†æ
- è‡ªåŠ¨æ£€æµ‹ä¿¡æ¯æ³„éœ²ç‰¹å¾
- åŸºäºå…¨å±€ç»Ÿè®¡çš„è¿‡æ»¤å»ºè®®

### 4. **é«˜åº¦å¯é…ç½®**
- æ”¯æŒçµæ´»çš„å‚æ•°é…ç½®
- å¯é€‰æ‹©ä¸åŒçš„å¤„ç†åç«¯
- æ”¯æŒé˜¶æ®µè·³è¿‡å’Œç‹¬ç«‹è¿è¡Œ

### 5. **ç”Ÿäº§å°±ç»ª**
- å®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—
- è¿›åº¦æ¡å’ŒçŠ¶æ€åé¦ˆ
- è¯¦ç»†çš„å¤„ç†æŠ¥å‘Š

## ğŸ“Š è¾“å‡ºæ•°æ®è¯´æ˜

### æœ€ç»ˆè®­ç»ƒæ•°æ®

- **æ–‡ä»¶**: `analysis/filtered_data.parquet`
- **å†…å®¹**: ç»è¿‡è´¨é‡åˆ†æå’Œæ™ºèƒ½è¿‡æ»¤çš„è®­ç»ƒå°±ç»ªæ•°æ®
- **ç‰¹å¾**: åªä¿ç•™é«˜è´¨é‡ã€æ— ä¿¡æ¯æ³„éœ²çš„ç‰¹å¾
- **æ ¼å¼**: Parquetæ ¼å¼ï¼Œä¾¿äºé«˜æ•ˆè¯»å–

### æ•°æ®è´¨é‡æŠ¥å‘Š

- **æ–‡ä»¶**: `analysis/data_analysis.json`
- **å†…å®¹**: è¯¦ç»†çš„æ•°æ®è´¨é‡åˆ†æç»“æœ
- **åŒ…æ‹¬**: åŸºç¡€ç»Ÿè®¡ã€é—®é¢˜ç‰¹å¾ã€ä¿¡æ¯æ³„éœ²æ£€æµ‹ã€è¿‡æ»¤å»ºè®®ç­‰

## ğŸ”§ é…ç½®å‚æ•°è¯´æ˜

### é€šç”¨å‚æ•°
- `--tickers`: è‚¡ç¥¨ä»£ç ç­›é€‰ï¼ˆå¯é€‰ï¼‰
- `--dates`: æŒ‡å®šå¤„ç†æ—¥æœŸï¼ˆå¯é€‰ï¼‰
- `--backend`: è®¡ç®—åç«¯ï¼ˆpolars/pandasï¼‰

### ç‰¹å¾ç›¸å…³
- `--extended_features`: æ˜¯å¦è®¡ç®—æ‰©å±•ç‰¹å¾

### æ ‡ç­¾ç›¸å…³
- `--r1_ms`: R1è§„åˆ™æ—¶é—´é˜ˆå€¼ï¼ˆé»˜è®¤50msï¼‰
- `--r2_ms`: R2è§„åˆ™æ—¶é—´é˜ˆå€¼ï¼ˆé»˜è®¤1000msï¼‰
- `--r2_mult`: R2è§„åˆ™ä»·å·®å€æ•°ï¼ˆé»˜è®¤4.0ï¼‰
- `--extended_labels`: æ˜¯å¦ä½¿ç”¨æ‰©å±•æ ‡ç­¾è§„åˆ™

### æ§åˆ¶å‚æ•°
- `--skip_stages`: è·³è¿‡æŒ‡å®šé˜¶æ®µï¼ˆå¦‚"1,2"ï¼‰

## ğŸ¯ æœ€ä½³å®è·µ

### 1. å¼€å‘é˜¶æ®µ
```bash
# å…ˆç”¨å°æ•°æ®é›†æµ‹è¯•
python scripts/data_process/complete_pipeline.py \
    --base_data_dir "/path/to/small_data" \
    --output_root "/path/to/test_output" \
    --dates 20230301 \
    --tickers 000001.SZ
```

### 2. ç”Ÿäº§ç¯å¢ƒ
```bash
# å®Œæ•´æ•°æ®å¤„ç†
python scripts/data_process/complete_pipeline.py \
    --base_data_dir "/path/to/full_data" \
    --output_root "/path/to/production_output" \
    --backend polars \
    --extended_features \
    --extended_labels
```

### 3. å¢é‡å¤„ç†
```bash
# åªå¤„ç†æ–°å¢æ—¥æœŸ
python scripts/data_process/complete_pipeline.py \
    --base_data_dir "/path/to/data" \
    --output_root "/path/to/output" \
    --dates 20230315 20230316 \
    --skip_stages "4"  # è·³è¿‡åˆ†æï¼Œåç»­ç»Ÿä¸€åˆ†æ
```

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **ç¼–ç é”™è¯¯**: ä½¿ç”¨è‡ªåŠ¨ç¼–ç æ£€æµ‹ï¼Œæ”¯æŒutf-8-sig/gbk/latin1
2. **å†…å­˜ä¸è¶³**: ä½¿ç”¨Polarsåç«¯ï¼Œæ”¯æŒLazyè®¡ç®—
3. **æ–‡ä»¶ç¼ºå¤±**: è¯¦ç»†çš„é”™è¯¯æç¤ºå’Œè·³è¿‡æœºåˆ¶
4. **ç‰¹å¾ä¸ä¸€è‡´**: æ–°æ¶æ„å®Œå…¨é¿å…äº†è¿™ä¸ªé—®é¢˜

### è°ƒè¯•å»ºè®®

1. ä½¿ç”¨å°æ•°æ®é›†å…ˆæµ‹è¯•
2. é€é˜¶æ®µè¿è¡Œï¼Œæ£€æŸ¥ä¸­é—´ç»“æœ
3. æŸ¥çœ‹è¯¦ç»†çš„æ—¥å¿—è¾“å‡º
4. æ£€æŸ¥ç”Ÿæˆçš„åˆ†ææŠ¥å‘Š

---

**æ³¨æ„**: è¿™ä¸ªæ–°æ¶æ„å®Œå…¨æ›¿ä»£äº†åŸæœ‰çš„ETLæµç¨‹ï¼Œæä¾›äº†æ›´å¥½çš„æ¨¡å—åŒ–ã€å¯ç»´æŠ¤æ€§å’Œæ•°æ®è´¨é‡æ§åˆ¶ã€‚å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­é€æ­¥è¿ç§»åˆ°æ–°æ¶æ„ã€‚ 